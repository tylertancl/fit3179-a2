{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": "container",
  "height": 560,
  "data": {"url": "data/medals_total.csv", "format": {"type": "csv"}},
  "transform": [
    {"calculate": "toNumber(datum.Total)", "as": "TotalMedals"},
    {"calculate": "datum['Country Code'] || datum['Country_Code'] || datum.NOC || datum['NOC'] || datum['Country code']", "as": "CountryCode"},
    {"lookup": "CountryCode", "from": {"data": {"url": "data/athlete_counts.csv", "format": {"type": "csv"}}, "key": "country_code", "fields": ["AthleteCount"]}},
    {"filter": "datum.AthleteCount != null"},
    {"calculate": "toNumber(datum.AthleteCount)", "as": "AthleteCount"},
    {"filter": "datum.AthleteCount > 0"},
    {"calculate": "datum.TotalMedals / datum.AthleteCount", "as": "Efficiency"}
  ],

  "layer": [
    {
      "mark": {"type": "point", "filled": true},
      "encoding": {
        "x": {"field": "AthleteCount", "type": "quantitative", "title": "Number of Athletes", "scale": {"zero": false}},
        "y": {"field": "TotalMedals", "type": "quantitative", "title": "Total Medals", "scale": {"zero": true}},
        "size": {"field": "TotalMedals", "type": "quantitative", "title": "Medals (size)", "scale": {"range": [30, 120]}, "legend": {"titleFontSize": 14, "labelFontSize": 12, "symbolSize": 160}},
        "color": {"field": "Efficiency", "type": "quantitative", "title": "Medals per Athlete", "scale": {"scheme": "blues"}, "legend": {"titleFontSize": 14, "labelFontSize": 12, "symbolSize": 160}},
        "tooltip": [
          {"field": "Country", "type": "nominal", "title": "Country"},
          {"field": "CountryCode", "type": "nominal", "title": "Country Code"},
          {"field": "AthleteCount", "type": "quantitative", "title": "Athletes"},
          {"field": "TotalMedals", "type": "quantitative", "title": "Medals"},
          {"field": "Efficiency", "type": "quantitative", "title": "Medals per Athlete", "format": ".4f"}
        ]
      }
    },
    {
      "data": {"values": [{"x": 230, "y": 100, "label": "Russia has a high \nmedals-to-athlete ratio"}]},
      "transform": [
        {"calculate": "datum.x + 120", "as": "x2"},
        {"calculate": "datum.y - 25", "as": "y2"}
      ],
      "layer": [
        {
          "mark": {"type": "text", "align": "left", "baseline": "top", "dx": 6, "font": "Calibri", "fontSize": 16, "lineBreak": "\n", "lineHeight": 16},
          "encoding": {"x": {"field": "x", "type": "quantitative"}, "y": {"field": "y2", "type": "quantitative"}, "text": {"field": "label"}}
        }
      ]
    }
  ],

  "config": {"axis": {"grid": false}}
}
