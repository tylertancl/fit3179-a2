{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "background": "transparent",
  "width": "container",
  "height": 540,

  "data": { "url": "https://raw.githubusercontent.com/tylertancl/fit3179-a2/main/data/medals_total.csv", "format": {"type": "csv"} },

  "params": [
    { "name": "med", "value": "All" }
  ],

  "transform": [
    { "calculate": "(datum.NOC || datum.noc || datum['Team/NOC'] || datum.Team || datum.team || datum.Country || datum.country || 'Unknown')", "as": "Country" },
    { "calculate": "(datum.Total || datum.total || datum.TOTAL || datum['Total medals'] || datum['Total Medals'] || '')", "as": "TotalRaw" },
    { "calculate": "(datum.Gold || datum.gold || datum['Gold Medal'] || datum['Gold Medals'] || datum.Gold_Medals || datum.gold_medals || '')", "as": "GoldRaw" },
    { "calculate": "(datum.Silver || datum.silver || datum['Silver Medal'] || datum['Silver Medals'] || datum.Silver_Medals || datum.silver_medals || '')", "as": "SilverRaw" },
    { "calculate": "(datum.Bronze || datum.bronze || datum['Bronze Medal'] || datum['Bronze Medals'] || datum.Bronze_Medals || datum.bronze_medals || '')", "as": "BronzeRaw" },

    { "calculate": "toNumber(replace(replace(datum.TotalRaw, /,/g, ''), /\\s+/g, ''))", "as": "TotalNum" },
    { "calculate": "toNumber(replace(replace(datum.GoldRaw, /,/g, ''), /\\s+/g, ''))", "as": "GoldNum" },
    { "calculate": "toNumber(replace(replace(datum.SilverRaw, /,/g, ''), /\\s+/g, ''))", "as": "SilverNum" },
    { "calculate": "toNumber(replace(replace(datum.BronzeRaw, /,/g, ''), /\\s+/g, ''))", "as": "BronzeNum" },

    { "filter": "datum.Country !== 'Unknown' && isFinite(datum.TotalNum) && datum.TotalNum > 0" },
    { "window": [{"op": "rank", "as": "r"}], "sort": [{"field": "TotalNum", "order": "descending"}] },
    { "filter": "datum.r <= 20" },

    { "fold": ["BronzeNum", "SilverNum", "GoldNum"], "as": ["MedalType", "MedalCount"] },
    { "calculate": "datum.MedalType == 'BronzeNum' ? 'Bronze' : (datum.MedalType == 'SilverNum' ? 'Silver' : 'Gold')", "as": "MedalLabel" },
    { "calculate": "datum.MedalLabel == 'Bronze' ? 1 : (datum.MedalLabel == 'Silver' ? 2 : 3)", "as": "MedalOrder" },

    { "filter": "med == 'All' || datum.MedalLabel == med" }
  ],

  "layer": [
    {
      "mark": {"type": "bar", "cornerRadiusEnd": 3},
      "encoding": {
        "y": {"field": "Country", "type": "nominal", "sort": "-x", "title": null},
        "x": {"aggregate": "sum", "field": "MedalCount", "type": "quantitative", "title": "Medals", "axis": {"grid": false}},
        "color": {
          "field": "MedalLabel",
          "type": "nominal",
          "title": "Medal",
          "scale": {"domain": ["Bronze", "Silver", "Gold"], "range": ["#C9961A", "#9BA1A8", "#FDCE1E"]},
          "legend": {
            "titleFontSize": 16,
            "labelFontSize": 14,
            "symbolSize": 180,
            "orient": "right"
          }
        },
        "order": {"field": "MedalOrder", "type": "quantitative", "sort": "ascending"},
        "tooltip": [
          {"field": "Country", "title": "NOC/Country"},
          {"field": "MedalLabel", "title": "Medal Type"},
          {"aggregate": "sum", "field": "MedalCount", "title": "Count", "type": "quantitative"}
        ]
      }
    },
    {
      "mark": {"type": "text", "align": "left", "dx": 6, "baseline": "middle"},
      "encoding": {
        "y": {"field": "Country", "type": "nominal", "sort": "-x"},
        "x": {"aggregate": "sum", "field": "MedalCount", "type": "quantitative"},
        "text": {"aggregate": "sum", "field": "MedalCount", "type": "quantitative"}
      }
    },
    {
  "transform": [
    { "aggregate": [{ "op": "max", "field": "MedalCount", "as": "xmax" }] }
      ],
      "layer": [
        {
          "mark": {
            "type": "rect",
            "fill": "white",
            "stroke": "#333",
            "strokeWidth": 1,
            "cornerRadius": 6,
            "opacity": 0.9
          },
          "encoding": {
            "x": { "value": 840 },
            "x2": { "value": 590 },
            "y": { "value": 270 },
            "y2": { "value": 360 }
          }
        },
        {
          "mark": {
            "type": "text",
            "font": "Georgia",
            "fontSize": 14,
            "align": "left",
            "baseline": "top",
            "lineBreak": "\n",
            "lineHeight": 18
          },
          "encoding": {
            "x": { "value": 595},
            "y": { "value": 275 },
            "text": {
              "value": "Key Insight:\nUSA, China, and Russia lead the\ntotal medal table. Use the medal\nbuttons to view each layer separately."
            }
          }
        }
      ]
    }
  ]
}
